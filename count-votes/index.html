<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
      crossorigin="anonymous"
    />

    <!-- Stellar SDK -->

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/7.0.0/stellar-sdk.min.js"
      integrity="sha512-AGpfxQX0hj6dYqSjSzRs9MosacqUTDHlVT4Ym0RiCbFHIMWXKsUrGq2C4yrF04fMzq3C73VxNZNOUbqxqr0pOg=="
      crossorigin="anonymous"
    ></script>
    <script>
      console.log(StellarSdk);
    </script>

    <!-- crypto.js -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"
      integrity="sha512-nOQuvD9nKirvxDdvQ9OMqe2dgapbPB7vYAMrzJihw5m+aNcf0dX53m6YxM4LgA9u8e9eg9QX+/+mPu8kCNpV2A=="
      crossorigin="anonymous"
    ></script>

    <!-- URI.js -->

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.19.2/URI.min.js"
      integrity="sha512-YQAqeLT4VuAZV80lmk6OE3XtmMW3eDxUtNf2V2w16eypX21CDtelaVsFD1QLUBCQuJEenK3jPqYPmpNUasdktA=="
      crossorigin="anonymous"
    ></script>

    <!-- axios -->

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.0/axios.min.js"
      integrity="sha512-DZqqY3PiOvTP9HkjIWgjO6ouCbq+dxqWoJZ/Q+zPYNHmlnI2dQnbJ5bxAHpAMw+LXRm4D72EIRXzvcHQtE8/VQ=="
      crossorigin="anonymous"
    ></script>

    <!-- QR code generator -->

    <script
      src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"
      integrity="sha256-xUHvBjJ4hahBW8qN9gceFBibSFUzbe9PNttUvehITzY="
      crossorigin="anonymous"
    ></script>

    <!-- My scripts -->

    <script>
      function index(obj, i) {
        return obj[i];
      }

      function isValidUrl(string) {
        try {
          new URL(string);
        } catch (_) {
          return false;
        }

        return true;
      }

      function isValidDate(d) {
        return d instanceof Date && !isNaN(d);
      }

      async function countVotes() {
        var server = new StellarSdk.Server(
          "https://horizon-testnet.stellar.org"
        );

        var callback = function (resp) {
          console.log(resp);

          console.log(
            resp.created_at,
            resp.from,
            resp.to,
            resp._links.transaction.href
          );

          var dateParsed = new Date(Date.parse(resp.created_at));

          var dateFrom = new Date(
            Date.parse(document.getElementById("countFrom").value)
          );
          var dateTo = new Date(
            Date.parse(document.getElementById("countTo").value)
          );

          console.log("dates_parsed: ", dateParsed, dateFrom, dateTo);

          var voteAfterStart = dateParsed >= dateFrom;

          console.log("vote_after_start: ", voteAfterStart);

          var voteBeforeEnd = dateParsed <= dateTo;

          console.log("vote_before_end: ", voteBeforeEnd);

          console.log("isValidDate_dateTo", isValidDate(dateTo));

          if (!voteAfterStart) {
            return console.error("Vote cast too early");
          } else {
            if (isValidDate(dateTo) && !voteBeforeEnd) {
              return console.error("Vote cast too late");
            }
          }

          axios
            .get(resp._links.transaction.href)
            .then(function (response) {
              // handle success
              console.log(response);
              console.log(response.data.memo);

              var vUrl = isValidUrl(response.data.memo);

              console.log(vUrl);

              if (!vUrl) {
                return console.error("Url to JSON invalid");
              }

              var resGet =
                "https://expand-url-jhrespicio.herokuapp.com/?as=" +
                response.data.memo;
              axios.get(resGet).then(function (response) {
                // handle success
                console.log(response);

                console.log(response.data);

                var jUrl = response.data;
                // "https://run.mocky.io/v3/884284d5-472b-4ff5-b4d5-7ad2da14c99b";

                axios.get(jUrl).then(function (response) {
                  // handle success
                  console.log(response);

                  var credKey = document.getElementById("keyCred").value;
                  var hashEl = document.getElementById("elHash").value;
                  var transId = document.getElementById("idTrans").value;

                  console.log("Keys in JSON: ", credKey, hashEl, transId);

                  var credKeyO = ("data." + credKey)
                    .split(".")
                    .reduce(index, response);

                  var hashElO = ("data." + hashEl)
                    .split(".")
                    .reduce(index, response);

                  var transId = ("data." + transId)
                    .split(".")
                    .reduce(index, response);

                  console.log("Values in JSON: ", credKeyO, hashElO, transId);
                });
              });
            })
            .catch(function (error) {
              // handle error
              console.log(error);
            });
        };

        var es = server
          .payments()
          .forAccount(document.getElementById("publicKey").value)

          .stream({ onmessage: callback });
      }
    </script>

    <title>IIS - Count votes</title>
  </head>

  <body>
    Â 

    <div class="bg-dark text-light text-center">
      <small>This page interacts with the test network ðŸ§ª</small>
    </div>

    <ul class="nav">
      <li class="nav-item">
        <a class="nav-link" href="../"><strong>IIS</strong></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="../create-an-account/">Create an account</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="../request-credentials/"
          >Request credentials</a
        >
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../certify-credentials/"
          >Certify credentials</a
        >
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../verify-credentials/">Verify credentials</a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../merge-links/">Merge links</a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="../vote/">Vote</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="../count-votes/">Count votes</a>
      </li>
    </ul>
    Â 

    <div class="container">
      <div class="row">
        <div class="col-md-5">
          <h1 class="">Count votes</h1>

          <form>
            <div class="form-group">
              <label for="formGroupExampleInput"
                >Votes for this public key</label
              >
              <input
                type="text"
                class="form-control"
                id="publicKey"
                placeholder="G"
                required
              />
            </div>

            <div class="form-group">
              <label for="formGroupExampleInput"
                >Key for the election hash</label
              >
              <input
                type="text"
                class="form-control"
                id="elHash"
                placeholder="election_hash"
              />
            </div>

            <div class="form-group">
              <label for="formGroupExampleInput"
                >Key for the transaction hash to the required credential to
                vote</label
              >
              <input
                type="text"
                class="form-control"
                id="keyCred"
                placeholder="credential"
              />
            </div>

            <div class="form-group">
              <label for="formGroupExampleInput"
                >Key for the transaction hash to the joined identity
                credentials</label
              >
              <input
                type="text"
                class="form-control"
                id="idTrans"
                placeholder="id_trans"
              />
            </div>

            <div class="form-group">
              <label for="formGroupExampleInput"
                >Count votes cast starting date and time</label
              >
              <input
                type="datetime-local"
                class="form-control"
                id="countFrom"
                placeholder=""
              />
            </div>

            <div class="form-group">
              <label for="formGroupExampleInput"
                >Count votes cast until date and time (optional)</label
              >
              <input
                type="datetime-local"
                class="form-control"
                id="countTo"
                placeholder=""
              />
            </div>

            <input
              id="countButton"
              type="button"
              class="btn btn-primary"
              onclick="countVotes()"
              value="Count"
            />
          </form>
        </div>
      </div>
    </div>

    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: jQuery and Bootstrap Bundle (includes Popper) -->
    <script
      src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
      integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
      crossorigin="anonymous"
    ></script>

    <!-- Option 2: jQuery, Popper.js, and Bootstrap JS
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>
    -->
  </body>
</html>
