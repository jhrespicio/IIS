<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">


    <!-- Stellar SDK -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/7.0.0/stellar-sdk.min.js"></script>
    <script>
        console.log(StellarSdk);
    </script>



    <!-- crypto.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>


    <!-- URI.js -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.19.2/URI.min.js"></script>

    <!-- axios -->

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>





    <!-- My scripts -->

    <script>

        // new

        function checkUncheck(clicked_id) {
            $("#" + clicked_id).each(function () {
                var $this = $(this);

                if ($this.is(":checked")) {
                    console.log(clicked_id)



                    var clickedCredHash = clicked_id + "-credHash"
                    var clickedDestinationId = clicked_id + "-destinationId"
                    var clickedCredSource = clicked_id + "-credSource"
                    var clickedCertProof = clicked_id + "-certProof"
                    var clickedCredDate = clicked_id + "-credDate"
                    var clickedTranHash = clicked_id + "-tranHash"
                    var clickedVerified = clicked_id + "-verified"



                    var credLineId = clicked_id + "-credLineHidden"
                    var certProofPlainId = clicked_id + "-certProofPlainHidden"
                    var tranHashId = clicked_id + "-tranHashHidden"

                    var credLine = document.getElementById(credLineId).innerHTML
                    var certProofPlain = document.getElementById(certProofPlainId).innerHTML
                    var tranHash = document.getElementById(tranHashId).innerHTML

                    var credData = { "credLine": credLine, "certProof": certProofPlain, "tranHash": tranHash };

                    myArray.push(credData)


                    console.log(myArray, "clicked")

                    var arrStr = encodeURIComponent(JSON.stringify(myArray));
                    $('#credentialsLink').attr({ href: '/verify-credentials/?array=' + arrStr });

                    console.log(arrStr)

                    document.getElementById("credentialsLink").innerHTML = '/verify-credentials/?array=' + arrStr



                    var credsLinkUrl = '/verify-credentials/?array=' + arrStr
                    document.getElementById("credsLinkModal").innerHTML =

                        '<a href="' + credsLinkUrl + '" class="alert-link" target="_blank" >' + credsLinkUrl + '</a>'





                } else {
                    console.log(clicked_id, "not")

                    console.log(clicked_id)



                    var clickedCredHash = clicked_id + "-credHash"
                    var clickedDestinationId = clicked_id + "-destinationId"
                    var clickedCredSource = clicked_id + "-credSource"
                    var clickedCertProof = clicked_id + "-certProof"
                    var clickedCredDate = clicked_id + "-credDate"
                    var clickedTranHash = clicked_id + "-tranHash"
                    var clickedVerified = clicked_id + "-verified"



                    var credLineId = clicked_id + "-credLineHidden"
                    var certProofPlainId = clicked_id + "-certProofPlainHidden"
                    var tranHashId = clicked_id + "-tranHashHidden"

                    var credLine = document.getElementById(credLineId).innerHTML
                    var certProofPlain = document.getElementById(certProofPlainId).innerHTML
                    var tranHash = document.getElementById(tranHashId).innerHTML

                    var credData = { "credLine": credLine, "certProof": certProofPlain, "tranHash": tranHash };

                    // myArray.push(credData)
                    var toDelete = new Set([tranHash]);
                    myArray = myArray.filter(obj => !toDelete.has(obj.tranHash));




                    console.log(myArray, "not clicked")

                    var arrStr = encodeURIComponent(JSON.stringify(myArray));
                    $('#credentialsLink').attr({ href: '/verify-credentials/?array=' + arrStr });

                    console.log(arrStr)

                    document.getElementById("credentialsLink").innerHTML = '/verify-credentials/?array=' + arrStr



                    var credsLinkUrl = '/verify-credentials/?array=' + arrStr
                    document.getElementById("credsLinkModal").innerHTML =

                        '<a href="' + credsLinkUrl + '" class="alert-link" target="_blank" >' + credsLinkUrl + '</a>'

                }
            });
        }



        async function writeSuccess(certProofS, credLineS, resultMemoS, destinationIdS, resultSourceAccountS, resultCreatedAtS, resultHashS, verified) {


            var certProof = certProofS
            var credLine = credLineS
            var resultMemo = resultMemoS
            var destinationId = destinationIdS
            var resultSourceAccount = resultSourceAccountS
            var resultCreatedAt = resultCreatedAtS
            var resultHash = resultHashS
            var verified = verified


            var credSource = resultSourceAccount
            var credDate = resultCreatedAt
            var tranHash = resultHash

            var certProofPlain;

            URI.withinString(certProof, function (url) {
                certProof = '<a href="' + url + '" class="alert-link" target="_blank" >' + url + '</a>'

                certProofPlain = url
            })

            var credLineA, credLineAUrl;
            URI.withinString(credLine, function (url) {

                credLineA = '<a href="' + url + '" class="alert-link" target="_blank" >' + url + '</a>'

                credLineAUrl = url
            })

            console.log(credLine, credLineA, credLineAUrl)


            var credLineAd = credLine.replaceAll(credLineAUrl, credLineA)

            console.log(credLine)




            var credHash = resultMemo

            if (verified) {
                verified = '<span class="text-primary">' + verified + '</span>'
            }
            else {
                verified = '<span class="text-danger">' + verified + '</span>'
            }


            var certProofPlainHidden = certProofPlain
            var credLineHidden = credLine
            var tranHashHidden = tranHash

            console.log(certProofPlain)

            var credEntry =

                `
                
<span id="${tranHash}-certProofPlainHidden" class="d-none">${certProofPlainHidden}</span><span id="${tranHash}-credLineHidden" class="d-none">${credLineHidden}</span><span id="${tranHash}-tranHashHidden" class="d-none">${tranHashHidden}</span>

                <hr><span class="badge badge-secondary mb-2">Credential</span>
                <div class="form-group form-check mb-0">
    <input type="checkbox" class="form-check-input" id="${tranHash}" onclick="checkUncheck(this.id)" checked>
    <label class="form-check-label" for="exampleCheck1"><h5 id="credLineId" class=""><span class="text-break" id="${tranHash}-credLine">${credLineAd}</span></h5></label>
  </div>
                            <p><strong>Hash: </strong><span class="text-break text-info" id="${tranHash}-credHash">${credHash}</span></p>

                            <p><strong>Owner: </strong><span class="text-break text-primary" id="${tranHash}-destinationId">${destinationId}</span></p>

                            
                            <p><strong>Certifier: </strong><span class="text-break text-danger" id="${tranHash}-credSource">${credSource}</p>
                            <p><strong>Certifier's ID proof: </strong><span class="text-break" id="${tranHash}-certProof">${certProof}</span></p>
                            <p><strong>Date certified: </strong><span class="text-break" id="${tranHash}-credDate">${credDate}</span></p>
                            <p><strong>Transaction hash: </strong><span class="text-break" id="${tranHash}-tranHash">${tranHash}</span></p>
                            <h4><strong>Verified: </strong><span class="text-break" id="${tranHash}-verified">${verified}</span></h4>
                            
                            `





            console.log(credEntry)


            $("#credsList").append(credEntry);

            document.getElementById("successAlert").classList.remove("d-none")



            var credData = { "credLine": credLine, "certProof": certProofPlain, "tranHash": tranHash };
            myArray.push(credData)
            var arrStr = encodeURIComponent(JSON.stringify(myArray));
            $('#credentialsLink').attr({ href: '/verify-credentials/?array=' + arrStr });

            console.log(arrStr)

            document.getElementById("credentialsLink").innerHTML = '/verify-credentials/?array=' + arrStr



            var credsLinkUrl = '/verify-credentials/?array=' + arrStr
            document.getElementById("credsLinkModal").innerHTML =

                '<a href="' + credsLinkUrl + '" class="alert-link" target="_blank" >' + credsLinkUrl + '</a>'


            document.getElementById("successAlert").classList.remove("d-none")
            document.getElementById("linkCorrupted").classList.add("d-none")

        }

        var myArray = [];

        window.onload = function () {
            const queryString = window.location.search;
            console.log(queryString);
            // ?product=shirt&color=blue&newuser&size=m

            const urlParams = new URLSearchParams(queryString);

            const array = urlParams.get('array')
            console.log(array);
            // shirt


            var json = array;

            var obj = JSON.parse(json);

            console.log(obj);

            var tHashes = []
            for (let index = 0; index < obj.length; index++) {
                var tHashObj = obj[index]
                var tHash = tHashObj.tranHash
                var tLine = tHashObj.credLine
                var tLineTHash = tLine + '^' + tHash + '^' + tHashObj.certProof
                tHashes.push(tLineTHash)
            }

            console.log(tHashes)

            var fruitsToGet = tHashes

            const forLoop = async _ => {
                console.log('Start')

                for (let index = 0; index < fruitsToGet.length; index++) {
                    const fruit = fruitsToGet[index]

                    var tLineTHashSplit = fruit.split('^')
                    var forTrans = tLineTHashSplit[1]
                    var line = tLineTHashSplit[0]

                    var certProofA = tLineTHashSplit[2]

                    console.log(forTrans, line)




                    try {
                        var respExData = await axios.get('https://horizon-testnet.stellar.org/transactions/' + forTrans);
                    } catch (error) {
                        console.error(error);
                        $('#exampleModal').modal('show')
                    }

                    var resp = respExData.data

                    console.log(resp, '- axios')


                    // retrieveOperation:

                    console.log(resp);
                    console.log(resp.memo);
                    console.log(base64ToHex(resp.memo).toLowerCase());
                    var respHash = base64ToHex(resp.memo).toLowerCase()
                    console.log(line)

                    // file v. string



                    if (!(new RegExp("([a-zA-Z0-9]+://)?([a-zA-Z0-9_]+:[a-zA-Z0-9_]+@)?([a-zA-Z0-9.-]+\\.[A-Za-z]{2,4})(:[0-9]+)?(/.*)?").test(line))) {
                        console.log(line)
                        var hash = CryptoJS.SHA256(line);
                        var lineHash = hash

                        console.log(lineHash)

                        var hashString = lineHash.toString()

                        console.log(hashString)

                        console.log(hashString == respHash)

                        var verified = hashString == respHash



                        var certProofS, credLineS, resultMemoS, destinationIdS, resultSourceAccountS, resultCreatedAtS, resultHashS
                        certProofS = certProofA
                        credLineS = line
                        resultMemoS = respHash



                        try {
                            var transOps = await axios.get('https://horizon-testnet.stellar.org/transactions/' + forTrans + '/operations');
                        } catch (error) {
                            console.error(error);
                            $('#exampleModal').modal('show')
                        }

                        console.log(transOps)

                        destinationIdS = transOps.data._embedded.records[0].to
                        resultSourceAccountS = transOps.data._embedded.records[0].from
                        resultCreatedAtS = transOps.data._embedded.records[0].created_at
                        resultHashS = forTrans
                        verified = verified

                        writeSuccess(certProofS, credLineS, resultMemoS, destinationIdS, resultSourceAccountS, resultCreatedAtS, resultHashS, verified)
                    }

                    if (new RegExp("([a-zA-Z0-9]+://)?([a-zA-Z0-9_]+:[a-zA-Z0-9_]+@)?([a-zA-Z0-9.-]+\\.[A-Za-z]{2,4})(:[0-9]+)?(/.*)?").test(line)) {
                        console.log("file")



                        var oneURL
                        var result = URI.withinString(line, function (url) {
                            console.log(url)
                            oneURL = url
                            return url
                        })


                        console.log(oneURL)
                        var verified

                        try {
                            const config = { responseType: 'blob' };
                            const response = await axios.get(oneURL, config
                            );

                            console.log(response)
                            var blob = response.data



                            var a = new FileReader();
                            a.readAsBinaryString(blob);
                            a.onloadend = function () {
                                var hash = CryptoJS.SHA256(CryptoJS.enc.Latin1.parse(a.result));


                                console.log(hash)
                                var lineHash = hash
                                console.log(lineHash)
                                console.log(lineHash.toString())

                                var hashString = lineHash.toString()

                                console.log(hashString)

                                console.log(hashString == respHash)

                                verified = hashString == respHash





                            };



                            var certProofS, credLineS, resultMemoS, destinationIdS, resultSourceAccountS, resultCreatedAtS, resultHashS
                            certProofS = certProofA
                            credLineS = line
                            resultMemoS = respHash



                            try {
                                var transOps = await axios.get('https://horizon-testnet.stellar.org/transactions/' + forTrans + '/operations');
                            } catch (error) {
                                console.error(error);
                                $('#exampleModal').modal('show')
                            }

                            console.log(transOps)

                            destinationIdS = transOps.data._embedded.records[0].to
                            resultSourceAccountS = transOps.data._embedded.records[0].from
                            resultCreatedAtS = transOps.data._embedded.records[0].created_at
                            resultHashS = forTrans
                            verified = verified

                            writeSuccess(certProofS, credLineS, resultMemoS, destinationIdS, resultSourceAccountS, resultCreatedAtS, resultHashS, verified)


                        } catch (error) {
                            console.error(error);




                            $('#exampleModal').modal('show')
                        }


                    }



                }

                console.log('End')
            }

            forLoop()


        }





        // old






        function base64ToHex(str) {
            const raw = atob(str);
            let result = '';
            for (let i = 0; i < raw.length; i++) {
                const hex = raw.charCodeAt(i).toString(16);
                result += (hex.length === 2 ? hex : '0' + hex);
            }
            return result.toUpperCase();
        }





    </script>



    <title>IIS - Verify credentials</title>
</head>



<body>  


    <div class="container my-5">

        <div class="row">
            <div class="col-md-6 offset-md-3 text-center">

                <a href="/">
                    <h4 class="font-weight-light">
                        <u>IIS</u>
                    </h4>
                </a>

                <h1 class="mb-4">Verify credentials</h1>

                <div id="linkCorrupted" class="alert alert-info" role="alert">
                    Paste your credentials link on the address bar.
                </div>

                <div class="text-left">




                    <div id="successAlert" class="alert alert-success mt-4 d-none" role="alert">


                        <a class="btn btn-success mt-2" href="#credsLink" role="button"
                            onclick="$('#linkModal').modal('show')">Get credentials link</a>

                        <small class="form-text text-muted">Uncheck a credential to remove it from the link.</small>

                        <div id="credsList">



                        </div>


                        <hr>
                        <a id="credsLink"></a>
                        <h4 class="text-success">Credentials link</h4>
                        <p class="mb-0"><a id="credentialsLink" class="alert-link text-break" target="_blank"
                                href=""></a></p>
                    </div>


                </div>


            </div>
        </div>
    </div>




    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Error</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="" class="alert alert-danger mt-3" role="alert">

                        Something went wrong.

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>

                </div>
            </div>
        </div>
    </div>



    <!-- Link modal -->


    <div class="modal fade" id="linkModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Credentials link</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="credsLinkModal" class="alert alert-success mt-3 text-break" role="alert">





                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>

                </div>
            </div>
        </div>
    </div>


    <!-- Optional JavaScript; choose one of the two! -->



    <!-- Option 1: jQuery and Bootstrap Bundle (includes Popper) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>

    <!-- Option 2: jQuery, Popper.js, and Bootstrap JS
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>
    -->



</body>

</html>